AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'GroupMe Webhook Handler Lambda with API Gateway (AWS SAM)'

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: python3.11

Parameters:
  UseSecretsManager:
    Type: String
    Description: Use AWS Secrets Manager for sensitive data (recommended for production)
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  SecretsManagerSecretName:
    Type: String
    Description: Name of Secrets Manager secret (only used if UseSecretsManager is true)
    Default: 'station95-chatbot/api-keys'

  # These parameters are only used if UseSecretsManager is false
  # Enter "UNUSED" if using Secrets Manager
  GroupMeBotId:
    Type: String
    Description: GroupMe Bot ID (enter UNUSED if using Secrets Manager)
    NoEcho: true
    Default: 'UNUSED'

  GroupMeApiToken:
    Type: String
    Description: GroupMe API Token (enter UNUSED if using Secrets Manager)
    NoEcho: true
    Default: 'UNUSED'

  GroupMeGroupId:
    Type: String
    Description: GroupMe Group ID (enter UNUSED if using Secrets Manager)
    NoEcho: true
    Default: 'UNUSED'

  AIProvider:
    Type: String
    Description: AI Provider (openai or anthropic)
    Default: openai
    AllowedValues:
      - openai
      - anthropic

  OpenAIApiKey:
    Type: String
    Description: OpenAI API Key (enter UNUSED if using Secrets Manager)
    NoEcho: true
    Default: 'UNUSED'

  AnthropicApiKey:
    Type: String
    Description: Anthropic API Key (enter UNUSED if using Secrets Manager)
    NoEcho: true
    Default: 'UNUSED'

  CalendarServiceUrl:
    Type: String
    Description: Calendar Service URL
    Default: 'http://localhost:8000/commands'

  ConfidenceThreshold:
    Type: Number
    Description: Confidence threshold for AI processing (0-100)
    Default: 70
    MinValue: 0
    MaxValue: 100

  RosterFilePath:
    Type: String
    Description: Path to roster file (relative to Lambda package)
    Default: 'data/roster.json'

  LogLevel:
    Type: String
    Description: Log level for Lambda function
    Default: INFO
    AllowedValues:
      - DEBUG
      - INFO
      - WARNING
      - ERROR
      - CRITICAL

  WebhookSecret:
    Type: String
    Description: Secret token for webhook authentication (will be checked in query param ?secret=XXX)
    Default: ''
    NoEcho: true

Resources:
  # S3 Bucket for logs
  LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-logs-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90

  # Lambda Function
  GroupMeWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-webhook-handler'
      CodeUri: .
      Handler: groupme_webhook_handler_lambda.lambda_handler
      Description: GroupMe webhook handler for shift scheduling
      Environment:
        Variables:
          SECRETS_MANAGER_SECRET_NAME: !If [UseSecretsManagerCondition, !Ref SecretsManagerSecretName, '']
          GROUPME_BOT_ID: !If [UseSecretsManagerCondition, 'UNUSED', !Ref GroupMeBotId]
          GROUPME_API_TOKEN: !If [UseSecretsManagerCondition, 'UNUSED', !Ref GroupMeApiToken]
          GROUPME_GROUP_ID: !If [UseSecretsManagerCondition, 'UNUSED', !Ref GroupMeGroupId]
          AI_PROVIDER: !Ref AIProvider
          OPENAI_API_KEY: !If [UseSecretsManagerCondition, 'UNUSED', !Ref OpenAIApiKey]
          ANTHROPIC_API_KEY: !If [UseSecretsManagerCondition, 'UNUSED', !Ref AnthropicApiKey]
          CALENDAR_SERVICE_URL: !Ref CalendarServiceUrl
          CONFIDENCE_THRESHOLD: !Ref ConfidenceThreshold
          ROSTER_FILE_PATH: !Ref RosterFilePath
          LOG_LEVEL: !Ref LogLevel
          LOGS_BUCKET: !Ref LogsBucket
          WEBHOOK_SECRET: !Ref WebhookSecret
      Events:
        WebhookPost:
          Type: HttpApi
          Properties:
            Path: /webhook
            Method: POST
        HealthCheckGet:
          Type: HttpApi
          Properties:
            Path: /
            Method: GET
        HealthCheckGet2:
          Type: HttpApi
          Properties:
            Path: /health
            Method: GET
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref LogsBucket
        - !If
          - UseSecretsManagerCondition
          - Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsManagerSecretName}*'
          - !Ref AWS::NoValue
      Tags:
        Application: Station95Chatbot

Conditions:
  UseSecretsManagerCondition: !Equals [!Ref UseSecretsManager, 'true']

Outputs:
  ApiEndpoint:
    Description: 'API Gateway Endpoint URL'
    Value: !Sub 'https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com'

  WebhookUrl:
    Description: 'GroupMe Webhook URL (use this in GroupMe bot configuration)'
    Value: !Sub 'https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com/webhook'

  WebhookUrlWithSecret:
    Description: 'Webhook URL with secret query parameter (if WebhookSecret is set)'
    Value: !Sub 'https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com/webhook?secret=${WebhookSecret}'

  LambdaFunctionArn:
    Description: 'Lambda Function ARN'
    Value: !GetAtt GroupMeWebhookFunction.Arn

  LambdaFunctionName:
    Description: 'Lambda Function Name'
    Value: !Ref GroupMeWebhookFunction

  LogsBucketName:
    Description: 'S3 Bucket for Logs'
    Value: !Ref LogsBucket
